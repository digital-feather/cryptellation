version: "3.5"

services:
    cockroachdb:
        container_name: cryptellation-tests-cockroachdb
        image: cockroachdb/cockroach
        ports:
            - 26257:26257
            - 26256:8080
        networks:
            - cryptellation-tests-network
        ulimits:
            nofile:
                soft: 65536
                hard: 65536
        command: start-single-node --insecure
        restart: unless-stopped
        volumes:
            - ../../services/candlesticks/configs/candlesticks.sql:/docker-entrypoint-initdb.d/candlesticks.sql
            - ../../services/exchanges/configs/exchanges.sql:/docker-entrypoint-initdb.d/exchanges.sql
    redis:
        container_name: cryptellation-tests-redis
        image: redis:alpine
        hostname: redis
        networks:
            - cryptellation-tests-network
    tests:
        container_name: cryptellation-tests
        build:
            context: ../..
            dockerfile: tests/integration/Dockerfile
        depends_on:
            - cockroachdb
            - redis
        image: cryptellation-testing
        env_file:
            - ../../.env
        volumes:
            - ../..:/code
        entrypoint: /code/tests/integration/entrypoint.sh
        networks:
            - cryptellation-tests-network

networks:
    cryptellation-tests-network:
